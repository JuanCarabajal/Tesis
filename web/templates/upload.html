{% extends "base.html" %}

{% block content %}
<section class="rounded-2xl border border-[var(--border)] bg-[color-mix(in_srgb,var(--card)_92%,#fff_8%)] p-6 md:p-10 shadow-[0_14px_40px_rgba(15,23,42,0.12)]">
  <div class="mb-6 flex flex-col md:flex-row md:items-center md:justify-between gap-3">
    <div>
      <h1 class="text-2xl font-semibold text-[var(--text)]">Sube tu demo de Mirage</h1>
      <p class="mt-1 text-sm text-[var(--muted)]">Selecciona un archivo <code>.dem</code> para analizar.</p>
    </div>
    <span class="rounded-full bg-[color-mix(in_srgb,var(--accent-2)_12%,var(--card))] px-3 py-1 text-xs text-[var(--text)] ring-1 ring-[color-mix(in_srgb,var(--accent-2)_35%,var(--border))] self-start md:self-auto">
      Tesis MVP - Mirage
    </span>
  </div>

  <form id="uploadForm" method="POST" action="{{ url_for('upload') }}" enctype="multipart/form-data" class="grid gap-6">
    <div class="rounded-2xl border border-[var(--border)] p-5 space-y-3 bg-[color-mix(in_srgb,var(--card)_94%,#fff_6%)]">
      <div class="text-sm font-medium text-[var(--text)]">Subir .dem</div>
      <div class="flex flex-col sm:flex-row sm:items-center gap-3">
        <input id="demInput" name="demo_file" type="file" accept=".dem" required
               class="w-full rounded-xl border border-[var(--border)] bg-[color-mix(in_srgb,var(--card)_95%,#0b12240a)] px-3 py-2 text-sm text-[var(--text)] placeholder:text-[var(--muted)] file:mr-3 file:rounded-lg file:border-0 file:bg-[color-mix(in_srgb,var(--accent-2)_12%,var(--card))] file:px-3 file:py-2 file:text-[var(--text)]">
        <button id="analyzeBtn" type="submit"
                class="rounded-2xl bg-[color-mix(in_srgb,var(--accent)_80%,var(--accent-2)_20%)] px-5 py-2 text-sm font-medium text-white shadow-lg shadow-emerald-500/20 hover:brightness-110">
          Analizar .dem
        </button>
      </div>
      <p class="mt-1 text-xs text-[var(--muted)]">Tamano tipico 50-300 MB.</p>
    </div>
  </form>
</section>

<!-- Overlay -->
<div id="overlay" class="fixed inset-0 z-50 hidden place-items-center bg-black/70 backdrop-blur-sm">
  <div class="w-[min(92vw,520px)] rounded-2xl bg-[color-mix(in_srgb,var(--card)_95%,#0f172a_5%)] p-6 ring-1 ring-[var(--border)]">
    <div class="mb-2 text-sm text-[var(--muted)]">Procesando demo. Esto puede tardar unos minutos.</div>
    <div class="mb-4 h-2 w-full overflow-hidden rounded-full bg-[var(--border)]">
      <div id="bar" class="h-full bg-violet-500 transition-all" style="width:0%"></div>
    </div>
    <div id="step" class="text-sm text-[var(--text)]">Preparando subida...</div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
(() => {
  const form = document.getElementById("uploadForm");
  const overlay = document.getElementById("overlay");
  const bar = document.getElementById("bar");
  const stepEl = document.getElementById("step");
  const btn = document.getElementById("analyzeBtn");
  if (!form || !overlay || !bar || !stepEl) return;

  form.addEventListener("submit", () => {
    if (!form.checkValidity()) return;
    overlay.classList.remove("hidden");
    overlay.classList.add("grid");
    if (btn) {
      btn.disabled = true;
      btn.classList.add("opacity-60", "cursor-not-allowed");
    }

    const totalMs = 5000 + Math.random() * 2000; // estimado del mock
    const milestones = [
      { limit: 20, text: "Subiendo demo..." },
      { limit: 55, text: "Procesando demo... Esto puede tardar unos minutos." },
      { limit: 85, text: "Generando feedback..." },
      { limit: 95, text: "Listo. Abriendo resumen..." }
    ];

    const started = performance.now();
    const tick = () => {
      const elapsed = performance.now() - started;
      const pct = Math.min(95, Math.round((elapsed / totalMs) * 95));
      bar.style.width = pct + "%";
      const next = milestones.find(m => pct <= m.limit) || milestones[milestones.length - 1];
      stepEl.textContent = next.text;
      if (pct >= 95) return;
      requestAnimationFrame(tick);
    };

    tick();
  });
})();
</script>
{% endblock %}
