{% extends "base.html" %}
{% set has_fb = fb is defined and fb %}
{% block content %}
<div id="summary-export" class="mx-auto max-w-6xl px-5 py-8 space-y-8" x-data>
  <style>
    /* Fallback para export a PDF: evita color-mix que html2canvas no soporta */
    #summary-export.exporting-pdf {
      background: #0b1224 !important;
      color: #e5e7eb !important;
    }
    #summary-export.exporting-pdf *[class*="color-mix"],
    #summary-export.exporting-pdf .surface,
    #summary-export.exporting-pdf .surface * {
      background: rgba(15,23,42,0.92) !important;
      border-color: rgba(255,255,255,0.08) !important;
      box-shadow: none !important;
      color: #e5e7eb !important;
      text-shadow: none !important;
    }
    #summary-export.exporting-pdf .text-[var(--muted)],
    #summary-export.exporting-pdf .text-[var(--muted)] *,
    #summary-export.exporting-pdf .text-[var(--text)],
    #summary-export.exporting-pdf .text-[var(--text)] * {
      color: #e5e7eb !important;
      opacity: 1 !important;
    }
    #summary-export.exporting-pdf img {
      filter: none !important;
    }
    #summary-export.exporting-pdf svg,
    #summary-export.exporting-pdf svg * {
      stroke: currentColor !important;
      fill: currentColor !important;
      color: #e5e7eb !important;
      opacity: 1 !important;
    }
  </style>

  <!-- Header / Match basics -->
  <section id="summary-header"
           class="rounded-2xl p-6 shadow-[0_10px_30px_rgba(15,23,42,0.08)] border border-[var(--border)] text-[var(--text)] surface">
    {% set score100 = (has_fb and (fb.summary.score100|int) or 83) %}
    {% set score5 = (score100 / 20.0) %}
    {% set score5_txt = "%.1f"|format(score5) %}

    <div class="flex flex-col gap-4 md:flex-row md:items-center md:justify-between">
      <div class="space-y-2">

        <div class="space-y-1">
          <h1 class="text-2xl md:text-3xl font-bold text-[var(--text)]" id="map-title">
            {{ has_fb and fb.summary.map or "Mirage" }}
          </h1>
          <p class="text-[var(--muted)] text-sm md:text-base">
            Score: <b id="score">{{ has_fb and fb.summary.score or "16-12" }}</b>
            · Duracion: <span id="duration">{{ has_fb and fb.summary.duration or "45:32" }}</span>
            · Rendimiento: <b id="score100">{{ score100 }}</b>/100
          </p>
        </div>

        <div class="flex flex-col gap-2 md:flex-row md:items-center md:gap-3">
          <span class="inline-flex items-center gap-1 px-3 py-1.5 rounded-xl bg-gradient-to-r from-emerald-500 to-sky-500 text-white shadow-sm">
            <span class="text-base font-semibold" id="score5-chip">{{ score5_txt }}</span>
            <span class="text-xs opacity-90">/ 5</span>
          </span>

          <div class="flex-1 min-w-[220px]">
            <div class="relative w-full h-2 rounded-full bg-[var(--border)] overflow-hidden">
              <div id="score-bar" class="absolute inset-0 bg-gradient-to-r from-emerald-400 to-sky-400"
                   style="width: {{ score100 }}%;"></div>
              <div class="absolute inset-0 flex justify-between">
                {% for _ in range(5) %}
                  <span class="h-2 w-px bg-black/10"></span>
                {% endfor %}
              </div>
            </div>
            <div class="flex justify-between text-[10px] text-[var(--muted)] mt-1">
              <span>0</span><span>1</span><span>2</span><span>3</span><span>4</span><span>5</span>
            </div>
          </div>

          <div class="mt-1" id="role-suggested">
            <span id="role-pill"
                  class="inline-flex items-center gap-2 px-3 py-1.5 rounded-xl text-emerald-900 bg-emerald-50 ring-1 ring-emerald-200">
              <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 opacity-90" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
              </svg>
              <span>Rol sugerido: <b id="role-name">Rifler</b></span>
            </span>
          </div>
        </div>
      </div>

      <div class="flex items-center gap-3 self-start md:self-center">
        <a href="{{ url_for('rounds_demo') if (not has_fb or not (fb.summary.match_id is defined and fb.summary.match_id)) else url_for('rounds_with_id', match_id=fb.summary.match_id) }}"
           class="inline-flex items-center justify-center rounded-lg px-4 py-2 border border-[var(--border)] text-[var(--text)] hover:bg-[color-mix(in_srgb,var(--card)_90%,#fff_10%)] transition">
          Ver por ronda
        </a>
        <button type="button" id="export-pdf-btn"
                class="inline-flex items-center justify-center rounded-lg px-4 py-2 bg-emerald-500 hover:bg-emerald-600 text-white transition">
          Exportar (PDF)
        </button>
      </div>
    </div>
  </section>

  <!-- Lado dominante -->
  {% set sides = has_fb and fb.sides or {} %}
  {% set sdata = sides.sides if sides and sides.sides is defined else {} %}
  <section class="space-y-3">
    <h2 class="text-xl md:text-2xl font-semibold text-[var(--text)] tracking-tight">Rendimiento por lado</h2>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
      {% for side_code, meta in {"T": sdata.get("T", {}), "CT": sdata.get("CT", {})}.items() %}
      <div class="p-4 rounded-xl surface shadow-[0_8px_24px_rgba(15,23,42,0.06)]">
        <div class="flex items-center justify-between">
          <div class="flex items-center gap-2">
            <span class="inline-flex items-center justify-center h-8 w-8 rounded-full text-sm font-semibold
                         {% if side_code == 'T' %}bg-amber-100 text-amber-700{% else %}bg-sky-100 text-sky-700{% endif %}">
              {{ side_code }}
            </span>
            <div>
              <p class="text-sm text-[var(--text)] font-semibold">Rondas: {{ meta.rounds or 0 }}</p>
              <p class="text-xs text-[var(--muted)]">Ganadas: {{ meta.won or 0 }}</p>
            </div>
          </div>
          <div class="text-right">
            <p class="text-2xl font-bold text-[var(--text)]">{{ (meta.win_rate or 0) }}%</p>
            <p class="text-xs text-[var(--muted)]">Win rate</p>
          </div>
        </div>
        <div class="mt-3 grid grid-cols-2 gap-2 text-xs text-[var(--text)]/90">
          <div class="p-2 rounded-lg border border-[var(--border)] bg-[color-mix(in_srgb,var(--card)_90%,#fff_10%)]">
            <p class="text-[var(--text)] font-semibold text-sm">{{ meta.plants or 0 }}</p>
            <p class="text-[var(--muted)]">Plants</p>
          </div>
          <div class="p-2 rounded-lg border border-[var(--border)] bg-[color-mix(in_srgb,var(--card)_90%,#fff_10%)]">
            <p class="text-[var(--text)] font-semibold text-sm">{{ meta.plant_conv or 0 }}%</p>
            <p class="text-[var(--muted)]">Conv. plants</p>
          </div>
        </div>
      </div>
      {% endfor %}
    </div>
  </section>

  <!-- KPI grid -->
  <section class="space-y-4">
    <h2 class="text-xl md:text-2xl font-semibold text-[var(--text)] tracking-tight">Metricas clave</h2>
    <div id="kpi-grid" class="grid grid-cols-2 md:grid-cols-3 xl:grid-cols-5 gap-4">
      {% set kpis = has_fb and fb.kpis or [
        {"name":"Kills / Deaths","value":"1.15","label":"Buen rendimiento"},
        {"name":"Eficiencia de Trades","value":"72%","label":"Buena"},
        {"name":"Control de Mid","value":"58%","label":"Inestable"},
        {"name":"Uso de Utilidades","value":"41%","label":"Bajo"},
        {"name":"Plant/Defuse","value":"62%","label":"Correcto"}
      ] %}
      {% for kpi in kpis %}
      <div class="group p-4 rounded-xl surface shadow-[0_8px_24px_rgba(15,23,42,0.06)] hover:shadow-[0_10px_28px_rgba(15,23,42,0.09)] transition">
        <p class="text-xs uppercase tracking-wide text-[var(--muted)]">{{ kpi.name }}</p>
        <p class="mt-1 text-2xl font-bold text-[var(--text)]">{{ kpi.value }}</p>
        <p class="text-xs text-[var(--muted)]">{{ kpi.label }}</p>
      </div>
      {% endfor %}
    </div>
  </section>

  <!-- Strengths / Weaknesses / Quick Wins -->
  <section class="space-y-4">
    <h2 class="text-xl md:text-2xl font-semibold text-[var(--text)] tracking-tight">Diagnostico tactico</h2>
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6" id="insights-grid">

      {% set strengths = has_fb and fb.insights.strengths or [
        "Control temprano de B",
        "Coordinacion en retakes",
        "Coberturas cruzadas efectivas en A"
      ] %}
      {% set weaknesses = has_fb and fb.insights.weaknesses or [
        "Falta de humo en CT",
        "Peek sin flash en mid",
        "Rotaciones tardias desde B"
      ] %}
      {% set quick_wins = has_fb and fb.insights.quick_wins or [
        "Practicar retake B (2v3) - 15 min",
        "Timings de rotacion mid->A - 10 min",
        "Set de humos A site - 10 min"
      ] %}

      <div class="rounded-2xl p-5 border border-[color-mix(in_srgb,var(--accent)_45%,var(--border))] bg-[color-mix(in_srgb,var(--card)_88%,#10b98120)] shadow-[0_8px_24px_rgba(15,23,42,0.08)]">
        <h3 class="font-semibold text-[var(--text)] flex items-center gap-2">Puntos fuertes</h3>
        <ul class="mt-3 list-disc pl-5 text-sm text-[var(--text)]/90 space-y-1" id="strengths">
          {% for item in strengths %}<li>{{ item }}</li>{% endfor %}
        </ul>
      </div>

      <div class="rounded-2xl p-5 border border-[color-mix(in_srgb,#f59e0b_35%,var(--border))] bg-[color-mix(in_srgb,var(--card)_90%,#f59e0b1a)] shadow-[0_8px_24px_rgba(15,23,42,0.05)]">
        <h3 class="font-semibold text-[var(--text)] flex items-center gap-2">Puntos debiles</h3>
        <ul class="mt-3 list-disc pl-5 text-sm text-[var(--text)]/90 space-y-1" id="weaknesses">
          {% for item in weaknesses %}<li>{{ item }}</li>{% endfor %}
        </ul>
      </div>

      <div class="rounded-2xl p-5 border border-[color-mix(in_srgb,var(--accent-2)_35%,var(--border))] bg-[color-mix(in_srgb,var(--card)_90%,#0ea5e91a)] shadow-[0_8px_24px_rgba(15,23,42,0.05)]">
        <h3 class="font-semibold text-[var(--text)] flex items-center gap-2">Quick wins</h3>
        <ul class="mt-3 list-disc pl-5 text-sm text-[var(--text)]/90 space-y-1" id="quickwins">
          {% for item in quick_wins %}<li>{{ item }}</li>{% endfor %}
        </ul>
      </div>
    </div>
  </section>

  <!-- Visual / Heatmap placeholder -->
  <section class="space-y-2">
    <h2 class="text-xl md:text-2xl font-semibold text-[var(--text)] tracking-tight">Mapa de calor K/D</h2>
    <div class="rounded-2xl overflow-hidden border border-[var(--border)] shadow-[0_10px_30px_rgba(15,23,42,0.08)]">
      <img id="heatmap-img"
           src="{{ url_for('static', filename='brand/heatmap_mock.png') }}"
           alt="Heatmap Mirage (placeholder)"
           class="w-full h-auto max-h-[560px] object-contain mx-auto select-none">
    </div>
  
  </section>

  <!-- Sugerencias de entrenamiento (extra para pantallazo) -->
  <section class="space-y-4">
    <h2 class="text-xl md:text-2xl font-semibold text-[var(--text)] tracking-tight">Sugerencias de entrenamiento</h2>
    <div id="training-list" class="grid md:grid-cols-2 gap-4">
      {% set training = has_fb and fb.training or [
        {"title":"Set de humos A (Mirage)","tip":"Pulir lineup desde Tetris y Palace - objetivo: consistencia 90%."},
        {"title":"Retake B (2v3)","tip":"Roles claros y flash pop desde short - 3 repeticiones por sesion."},
        {"title":"Peeks en Mid con flash","tip":"Evitar dry peeks en timings previsibles - usar one-way top mid."},
        {"title":"Rotaciones mas tempranas","tip":"Definir callee + trigger de rotacion al primer info de presencia."}
      ] %}
      {% for t in training %}
      <div class="rounded-2xl p-4 border border-[color-mix(in_srgb,var(--accent)_35%,var(--border))] bg-[color-mix(in_srgb,var(--card)_95%,#fff_8%)] backdrop-blur-md transition-all duration-300 hover:-translate-y-0.5 hover:border-[color-mix(in_srgb,var(--accent)_50%,var(--border))] hover:shadow-[0_10px_26px_rgba(15,23,42,0.08)]">
        <p class="font-medium text-[var(--text)]">{{ t.title }}</p>
        <p class="text-sm text-[var(--muted)]">{{ t.tip }}</p>
      </div>
      {% endfor %}
    </div>
  </section>

</div>

<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<script>
(function() {
  const btn = document.getElementById("export-pdf-btn");
  const target = document.getElementById("summary-export");
  if (!btn || !target) return;

  btn.addEventListener("click", async () => {
    if (!(window.html2canvas && window.jspdf && window.jspdf.jsPDF)) {
      alert("No se pudo cargar el exportador PDF.");
      return;
    }
    btn.disabled = true;
    const prevLabel = btn.textContent;
    btn.textContent = "Generando PDF...";
    target.classList.add("exporting-pdf");
    try {
      const canvas = await html2canvas(target, {
        scale: 2,
        useCORS: true,
        scrollY: -window.scrollY,
        backgroundColor: "#0b1224"
      });
      const imgData = canvas.toDataURL("image/png");
      const pdf = new window.jspdf.jsPDF("p", "mm", "a4");
      const pageWidth = pdf.internal.pageSize.getWidth();
      const pageHeight = pdf.internal.pageSize.getHeight();

      // Escalar la imagen al ancho completo de la pagina y paginar si la altura supera A4.
      const imgWidth = pageWidth;
      const imgHeight = (canvas.height * pageWidth) / canvas.width;
      let position = 0;
      let heightLeft = imgHeight;

      pdf.addImage(imgData, "PNG", 0, position, imgWidth, imgHeight);
      heightLeft -= pageHeight;

      while (heightLeft > 0) {
        position = heightLeft - imgHeight;
        pdf.addPage();
        pdf.addImage(imgData, "PNG", 0, position, imgWidth, imgHeight);
        heightLeft -= pageHeight;
      }

      const filename = `sharpix-${document.getElementById("score")?.textContent || "summary"}.pdf`;
      pdf.save(filename);
    } catch (e) {
      console.error("PDF export error", e);
      alert("No se pudo exportar el PDF. Intenta nuevamente.");
    } finally {
      target.classList.remove("exporting-pdf");
      btn.disabled = false;
      btn.textContent = prevLabel;
    }
  });
})();
</script>

<script>
function updateRole(kpis) {
  try {
    if (!Array.isArray(kpis) || !kpis.length) return;
    const byId = (id) => {
      const it = kpis.find(k => k.id === id);
      return it && typeof it.value100 === 'number' ? it.value100 : 0;
    };
    const trades   = byId('trades_5s');
    const opening  = byId('opening_impact');
    const util     = byId('util_dmg_rd');
    const post     = byId('postplant');
    const clutch   = byId('clutch_2vx');

    const scores = [
      { key: 'entry',   label: 'Entry',    ring: 'ring-rose-300/40',    bg: 'bg-rose-400/15',    val: 0.60*opening + 0.40*trades },
      { key: 'support', label: 'Support',  ring: 'ring-sky-300/40',     bg: 'bg-sky-400/15',     val: 0.70*util    + 0.30*post   },
      { key: 'closer',  label: 'Closer',   ring: 'ring-amber-300/40',   bg: 'bg-amber-400/15',   val: 0.70*clutch  + 0.30*post   },
      { key: 'anchor',  label: 'Anchor',   ring: 'ring-violet-300/40',  bg: 'bg-violet-400/15',  val: 0.50*post    + 0.30*(100-opening) + 0.20*trades },
      { key: 'lurker',  label: 'Lurker',   ring: 'ring-emerald-300/40', bg: 'bg-emerald-400/15', val: 0.50*(100-trades) + 0.50*post },
      { key: 'awp',     label: 'AWPer',    ring: 'ring-indigo-300/40',  bg: 'bg-indigo-400/15',  val: 0.75*opening + 0.25*util }
    ];

    scores.sort((a,b)=>b.val-a.val);
    const best = scores[0];

    const pill = document.getElementById('role-pill');
    const name = document.getElementById('role-name');
    if (pill && name) {
      name.textContent = best.label;
      pill.className = "inline-flex items-center gap-2 px-3 py-1.5 rounded-xl text-white ring-1 backdrop-blur-sm " + best.bg + " " + best.ring + " ring-white/10";
    }
  } catch (e) {
    console.warn('updateRole error', e);
  }
}
</script>

{% if has_fb and fb.summary and fb.summary.suggested_role %}
<script>
  (function(){
    const role = {{ fb.summary.suggested_role | tojson }};
    const pill = document.getElementById('role-pill');
    const name = document.getElementById('role-name');
    if (pill && name) { name.textContent = role; }
  })();
</script>
{% elif has_fb and fb.kpis %}
<script>
  updateRole({{ fb.kpis | tojson | safe }});
</script>
{% endif %}

{% if not has_fb %}
<script>
(async () => {
  try {
    const res = await fetch("{{ url_for('static', filename='fixtures.json') }}", {cache: "no-store"});
    if (!res.ok) return;
    const fb = await res.json();

    const setText = (sel, val) => { const el = document.querySelector(sel); if (el && val != null) el.textContent = val; };
    setText("#map-title", fb?.summary?.map ?? "Mirage");
    setText("#score", fb?.summary?.score ?? "16-12");
    setText("#duration", fb?.summary?.duration ?? "45:32");
    const s100 = Number(fb?.summary?.score100 ?? 83);
    setText("#score100", String(s100));
    const bar = document.getElementById("score-bar");
    if (bar) bar.style.width = (Math.max(0, Math.min(100, s100))) + "%";
    const chip = document.getElementById("score5-chip");
    if (chip) chip.textContent = (s100/20).toFixed(1);

    const kpiGrid = document.getElementById("kpi-grid");
    if (kpiGrid && Array.isArray(fb?.kpis)) {
      kpiGrid.innerHTML = "";
      for (const k of fb.kpis) {
        const card = document.createElement("div");
        card.className = "group p-4 rounded-xl surface shadow-[0_8px_24px_rgba(15,23,42,0.06)] hover:shadow-[0_10px_28px_rgba(15,23,42,0.09)] transition";
        card.innerHTML = `
          <p class="text-xs uppercase tracking-wide text-[var(--muted)]">${k.name}</p>
          <p class="mt-1 text-2xl font-bold text-[var(--text)]">${k.value}</p>
          <p class="text-xs text-[var(--muted)]">${k.label ?? ""}</p>`;
        kpiGrid.appendChild(card);
      }
      updateRole(fb.kpis);
    }

    const renderList = (id, arr) => {
      const ul = document.getElementById(id);
      if (!ul || !Array.isArray(arr)) return;
      ul.innerHTML = "";
      for (const item of arr) {
        const li = document.createElement("li");
        li.textContent = item;
        ul.appendChild(li);
      }
    };
    renderList("strengths", fb?.insights?.strengths);
    renderList("weaknesses", fb?.insights?.weaknesses);
    renderList("quickwins", fb?.insights?.quick_wins);

    const training = fb?.training;
    const tList = document.getElementById("training-list");
    if (tList && Array.isArray(training)) {
      tList.innerHTML = "";
      for (const t of training) {
        const div = document.createElement("div");
        div.className = "rounded-2xl p-4 border border-[color-mix(in_srgb,var(--accent)_35%,var(--border))] bg-[color-mix(in_srgb,var(--card)_95%,#fff_8%)] backdrop-blur-md transition-all duration-300 hover:-translate-y-0.5 hover:border-[color-mix(in_srgb,var(--accent)_50%,var(--border))] hover:shadow-[0_10px_26px_rgba(15,23,42,0.08)]";
        div.innerHTML = `<p class="font-medium text-[var(--text)]">${t.title}</p>
                 <p class="text-sm text-[var(--muted)]">${t.tip}</p>`;
        tList.appendChild(div);
      }
    }
  } catch (e) {
    console.warn("No se pudo cargar fixtures.json (fallback).", e);
  }
})();
</script>
{% endif %}
{% endblock %}
